<launch>
    <!-- 参数 -->
    <arg name="rviz" default="true" />
    
    <!-- 1. Livox MID360 -->
    <include file="$(find livox_ros_driver2)/launch_ROS1/msg_MID360.launch"/>
    
    <!-- 2. FAST-LIO2 -->
    <include file="$(find fast_lio)/launch/mapping_mid360.launch">
        <arg name="rviz" value="false" />
    </include>
    
    <!-- 3. OctoMap + LaserScan (延迟3秒启动) -->
    <node pkg="octomap_server" type="octomap_server_node" name="octomap_server" 
          output="screen" launch-prefix="bash -c 'sleep 3; $0 $@' ">
        <remap from="cloud_in" to="/cloud_registered"/>
        <param name="resolution" value="0.1" />
        <param name="frame_id" value="camera_init" />
        <param name="sensor_model/max_range" value="20.0" />
        <param name="pointcloud_min_z" value="0.1" />
        <param name="pointcloud_max_z" value="2.0" />
        <param name="latch" value="true" />
        <param name="filter_speckles" value="true" />
    </node>
    
    <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" 
          name="pointcloud_to_laserscan" output="screen"
          launch-prefix="bash -c 'sleep 3; $0 $@' ">
        <remap from="cloud_in" to="/cloud_registered"/>
        <remap from="scan" to="/scan"/>
        <param name="target_frame" value="camera_init" />
        <param name="min_height" value="0.0" />
        <param name="max_height" value="2.0" />
        <param name="angle_min" value="-3.14159" />
        <param name="angle_max" value="3.14159" />
        <param name="range_min" value="0.3" />
        <param name="range_max" value="20.0" />
    </node>
    
    <!-- 4. RViz -->
    <group if="$(arg rviz)">
        <node pkg="rviz" type="rviz" name="rviz" 
              args="-d $(find fast_lio)/rviz_cfg/loam_livox.rviz" />
    </group>
</launch>