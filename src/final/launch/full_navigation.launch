<launch>
    <!-- ========== 1. 雷达驱动 ========== -->
    <include file="$(find livox_ros_driver2)/launch_ROS1/msg_MID360.launch"/>
    
    <!-- ========== 2. FAST-LIO2 建图 ========== -->
    <include file="$(find fast_lio)/launch/mapping_mid360.launch">
        <arg name="rviz" value="false"/>
    </include>
    
    <!-- ========== 2.1 补充TF链路 ========== -->
    <!-- FAST-LIO2发布: camera_init -> body/livox_frame -->
    <!-- 我们需要补充: map -> camera_init, camera_init -> base_link, odom -> base_link -->
    
    <!-- 方案A: 让AMCL发布 map -> odom，我们只需补充其他链路 -->
    <!-- camera_init 作为雷达坐标系，等同于 base_link -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="map_to_odom_temp" 
          args="0 0 0 0 0 0 1 map odom"/>
    
    <!-- odom -> base_link (假里程计) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="odom_to_base" 
          args="0 0 0 0 0 0 1 odom base_link"/>
    
    <!-- base_link -> camera_init (雷达安装位置) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_camera" 
          args="0 0 0 0 0 0 1 base_link camera_init"/>
    
    <!-- ========== 3. OctoMap + LaserScan ========== -->
    <node pkg="octomap_server" type="octomap_server_node" name="octomap_server" output="screen">
        <!-- 输入点云话题 -->
        <remap from="cloud_in" to="/cloud_registered"/>
        
        <!-- ========== 基础参数 ========== -->
        <param name="resolution" value="0.1" />              <!-- 地图分辨率(m) -->
        <param name="frame_id" type="string" value="map" />  <!-- 全局坐标系 -->
        <param name="sensor_model/max_range" value="20.0" /> <!-- 最大感知距离(m) -->
        
        <!-- ========== 2D地图投影参数 ========== -->
        <param name="pointcloud_min_z" value="0.1" />   <!-- 投影到2D的最小高度 -->
        <param name="pointcloud_max_z" value="2.0" />   <!-- 投影到2D的最大高度 -->
        <param name="occupancy_min_z" value="-0.1" />   <!-- 占据检测最小高度 -->
        <param name="occupancy_max_z" value="2.5" />    <!-- 占据检测最大高度 -->
        
        <!-- ========== 地图发布设置 ========== -->
        <param name="latch" value="true" />             <!-- 锁存地图话题 -->
        <param name="publish_free_space" value="false"/> <!-- 是否发布自由空间 -->
        <!-- ========== 滤波参数 ========== -->
        <param name="filter_ground" value="false" />    <!-- 不滤除地面 -->
        <param name="filter_speckles" value="true" />   <!-- 过滤孤立点 -->
        <param name="base_frame_id" value="base_link" /><!-- 机器人基座坐标系（可选） -->
        
        <!-- ========== 更新参数 ========== -->
        <param name="height_map" value="false" />       <!-- 不生成高度图 -->
        <param name="colored_map" value="false" />      <!-- 不使用彩色地图 -->
    </node>

    <!-- 点云转LaserScan节点 -->
    <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" 
          name="pointcloud_to_laserscan" output="screen">
        <remap from="cloud_in" to="/cloud_registered"/>
        <remap from="scan" to="/scan"/> 
        
        <param name="target_frame" value="base_link" />
        <param name="transform_tolerance" value="0.5" />
        <param name="min_height" value="0.0" />
        <param name="max_height" value="2.0" />
        
        <param name="angle_min" value="-3.14159" />
        <param name="angle_max" value="3.14159" />
        <param name="angle_increment" value="0.0087" />  <!-- 约0.5度 -->
        <param name="scan_time" value="0.1" />
        <param name="range_min" value="0.3" />
        <param name="range_max" value="20.0" />
        <param name="use_inf" value="true" />
        <param name="concurrency_level" value="1" />
    </node>
    <!-- ========== 4. 导航系统（延迟5秒启动） ========== -->
    <include file="$(find final)/launch/navigation.launch">
        <arg name="use_rviz" value="true"/>
    </include>
</launch>